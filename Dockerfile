FROM --platform=linux/amd64 fedora:latest

#install dependecies,
RUN dnf upgrade -y

RUN dnf -y install bind-utils cracklib-dicts firefox gdb gnupg golang hping3 \
    iputils iproute java-latest-openjdk java-latest-openjdk-devel \
    libaio libdrm libgbm libnsl libwayland-server libX11-xcb \
    mysql net-tools nmap nss openssh openssh-server openvpn passwd python-pip python3 python3-pip proxychains \
    tor sqlite sudo tcpdump tmux wget whois xclip xeyes zsh

RUN dnf module install -y ruby:2.7/default
RUN dnf -y install libpgf-devel postgresql-devel libpcap-devel

#install Metasploit
RUN curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && \
  chmod 755 msfinstall && \
  ./msfinstall
RUN rm msfinstall

#copy tor and proxychains config files into the container
COPY torrc /etc/tor/torrc
COPY proxychains.conf /etc/proxychains/proxychains.conf

#create new user pete
RUN useradd -G wheel -ms /bin/zsh pete
RUN echo thePassword | passwd pete --stdin
USER pete
WORKDIR /home/pete

#install ohmyzsh and choose a theme
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
RUN sed -i 's/ZSH_THEME="robbyrussell"/ZSH_THEME="sporty_256"/' /home/pete/.zshrc

#make TMUX prettier
RUN echo "# Enable mouse control in tmux (clickable windows, panes, resizable panes) \
    set -g mouse on \
    bind-key y run-shell 'tmux show-buffer | xclip -sel clip -i' \
    set -g default-terminal 'screen-256color'" >> ~/.tmux.conf 

#Download tools and scrips for exploit training
#nc .exe
RUN wget https://eternallybored.org/misc/netcat/netcat-win32-1.11.zip
RUN unzip -d ~/tools/windows/netcat/ netcat-win32-1.11.zip & rm netcat-win32-1.11.zip
RUN git clone https://github.com/carlospolop/PEASS-ng.git ~/tools/windows/winpeas 

#download gobuster, sqlmap, odat, impacket and SecList
ENV GOPATH=/home/pete/.go
RUN go get -v github.com/OJ/gobuster && \
    git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git ~/tools/sqlmap && \
    git clone --depth 1 https://github.com/danielmiessler/SecLists ~/tools/seclist && \
    git clone https://github.com/quentinhardy/odat ~/tools/odat && \
    git clone https://github.com/SecureAuthCorp/impacket impacket && \
    cd impacket && pip3 install --user . && cd .. && rm -rf impacket && \
    wget https://github.com/Konloch/bytecode-viewer/releases/download/v2.9.21/Bytecode-Viewer-2.9.21.jar -O tools/bytecode_viewer.jar && \
    wget https://ghidra-sre.org/ghidra_9.2_PUBLIC_20201113.zip -O ~/tools/ghidra.zip && cd ~/tools &&  unzip ghidra.zip && rm -rf ghidra.zip && \
    mv ghidra_9.2_PUBLIC ghidra

#install hydra
RUN git clone https://github.com/vanhauser-thc/thc-hydra ~/git/hydra
WORKDIR /home/pete/git/hydra
RUN ./configure
RUN make 
USER root
RUN make install

USER pete
WORKDIR /home/pete
#configure SSH server
COPY ./container_pete.pub /home/pete/.ssh/container_pete.pub
COPY burp_fix/chrome_fix.py /home/pete/burp_fix/chrome_fix.py
COPY burp_fix/burp_fix.sh /home/pete/burp_fix/burp_fix.sh

RUN ssh-keygen -A && \
    chown pete:pete /home/pete/.ssh/container_pete.pub && \
    chmod 644 /home/pete/.ssh/container_pete.pub && \
    sed -i 's/PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config.d/50-redhat.conf && \
    sed -i 's/GSSAPIAuthentication.*/GSSAPIAuthentication no/' /etc/ssh/sshd_config.d/50-redhat.conf && \
    sed -i 's/#X11Forwarding no/X11Forwarding yes/' /etc/ssh/sshd_config && \
    echo "export DISPLAY=:0" >> /home/pete/.zshrc && \
    echo "export PATH=$PATH:$GOPATH/bin" >> /home/pete/.zshrc && \
    echo "alias ghidra='bash /home/pete/tools/ghidra/ghidraRun'" >> /home/pete/.zshrc && \
    echo "alias bytecodevw='java -jar /home/pete/tools/bytecode_viewer.jar'" >> /home/pete/.zshrc 
    #passwd -d pete && passwd --expire pete

# download and install burp and sqlplus
RUN curl 'https://portswigger.net/burp/releases/download?product=community&type=JAR' -o burp.jar
RUN curl https://download.oracle.com/otn_software/linux/instantclient/213000/oracle-instantclient-basic-21.3.0.0.0-1.el8.x86_64.rpm -o instantclient.rpm
RUN curl https://download.oracle.com/otn_software/linux/instantclient/213000/oracle-instantclient-sqlplus-21.3.0.0.0-1.el8.x86_64.rpm -o sqlplus.rpm
RUN rpm -hiv instantclient.rpm sqlplus.rpm
RUN rm instantclient.rpm sqlplus.rpm

    #copy the jar executable to bin directory
RUN cp burp.jar /usr/local/bin/
RUN echo "alias burp=java --illegal-access=permit -jar /usr/local/bin/burp.jar" >> /home/pete/.zshrc

ENTRYPOINT [ "/sbin/sshd", "-D" ]


###
#Auf dem MAc: install xqaurtz (restart)
#clone project
#create keys
#build 
#run
#mac xhost +  or xhost local:root
###

#docker build . -t pete
#docker run -v '/Users/tobias.wilke/.vpn':'/home/pete/.vpn' --cap-add=NET_ADMIN --device /dev/net/tun --sysctl net.ipv6.conf.all.disable_ipv6=0 -p 4455:22 -d pete
#ssh -X -R 6000:localhost:6000 -L 8080:localhost:8080 -p 4455 pete@localhost -i container_pete -v

on mac and fedora
#export DISPLAY=:0